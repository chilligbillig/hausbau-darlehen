<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Darlehens-App Hausbau</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; }
    input, select, button { margin: 5px; padding: 5px; width: 100%; }
    .section { border: 1px solid #ccc; padding: 10px; margin-top: 20px; }
    .section h3 { margin-top: 0; }
  </style>
</head>
<body>
  <h1>Hausbau Darlehensübersicht</h1>

  <div class="section">
    <h3>Hauspreis</h3>
    <input type="number" id="kaufpreis" placeholder="Hauspreis in EUR">
  </div>

  <div class="section">
    <h3>Eigenkapital</h3>
    <input type="number" id="ek_benjamin" placeholder="Eigenkapital Benjamin">
    <input type="number" id="ek_sophia" placeholder="Eigenkapital Sophia">
    <div id="zusatz_ek"></div>
    <button onclick="addZusatzEK()">+ Weiteres Eigenkapital</button>
  </div>

  <div class="section">
    <h3>Darlehen</h3>
    <div id="darlehen_container"></div>
    <button onclick="addDarlehen()">+ Darlehen hinzufügen</button>
  </div>

  <div class="section">
    <h3>Berechnung</h3>
    <button onclick="berechne()">Berechnen</button>
    <div id="ergebnis"></div>
  </div>

  <script>
    let ek_counter = 0;
    let darlehen_counter = 0;

    function addZusatzEK() {
      const div = document.createElement('div');
      div.innerHTML = `<input type="number" placeholder="Zusatz-EK ${ek_counter + 1}" class="zusatz_ek">`;
      document.getElementById('zusatz_ek').appendChild(div);
      ek_counter++;
    }

    function addDarlehen() {
      const div = document.createElement('div');
      div.classList.add('darlehen');
      div.innerHTML = `
        <input type="text" placeholder="Name Darlehen ${darlehen_counter + 1}" class="dl_name">
        <input type="number" placeholder="Max. Betrag" class="dl_betrag">
        <input type="number" placeholder="Zinssatz %" class="dl_zins">
        <input type="number" placeholder="Laufzeit in Jahren" class="dl_laufzeit">
        <input type="number" placeholder="Reihenfolge" class="dl_reihenfolge">
        <hr>
      `;
      document.getElementById('darlehen_container').appendChild(div);
      darlehen_counter++;
    }

    function berechne() {
      const kaufpreis = parseFloat(document.getElementById('kaufpreis').value) || 0;
      const ek_benjamin = parseFloat(document.getElementById('ek_benjamin').value) || 0;
      const ek_sophia = parseFloat(document.getElementById('ek_sophia').value) || 0;
      const zusatz_eks = [...document.querySelectorAll('.zusatz_ek')].map(e => parseFloat(e.value) || 0);

      const gesamt_ek = ek_benjamin + ek_sophia + zusatz_eks.reduce((a, b) => a + b, 0);
      const finanzbedarf = kaufpreis - gesamt_ek;

      let darlehen = [...document.querySelectorAll('.darlehen')].map(div => {
        return {
          name: div.querySelector('.dl_name').value,
          betrag: parseFloat(div.querySelector('.dl_betrag').value) || 0,
          zins: parseFloat(div.querySelector('.dl_zins').value) / 100 || 0,
          laufzeit: parseFloat(div.querySelector('.dl_laufzeit').value) || 0,
          reihenfolge: parseInt(div.querySelector('.dl_reihenfolge').value) || 999
        };
      });

      darlehen = darlehen.sort((a, b) => a.reihenfolge - b.reihenfolge);

      let aufgenommene_darlehen = [];
      let verbleibend = finanzbedarf;

      for (let d of darlehen) {
        if (verbleibend <= 0) break;
        let betrag = Math.min(d.betrag, verbleibend);
        d.realbetrag = betrag;
        d.rate = berechneRate(betrag, d.zins, d.laufzeit);
        verbleibend -= betrag;
        aufgenommene_darlehen.push(d);
      }

      let gesamt_rate = aufgenommene_darlehen.reduce((sum, d) => sum + d.rate, 0);

      let html = `
        <p>Hauspreis: €${kaufpreis.toLocaleString()}</p>
        <p>Eigenkapital gesamt: €${gesamt_ek.toLocaleString()}</p>
        <p>Finanzierungsbedarf: €${finanzbedarf.toLocaleString()}</p>
        <p>Verbleibend: €${verbleibend.toLocaleString()}</p>
        <h4>Verwendete Darlehen:</h4>
        <ul>
          ${aufgenommene_darlehen.map(d => `<li>${d.name}: €${d.realbetrag.toLocaleString()} – Rate: €${d.rate.toFixed(2)}</li>`).join('')}
        </ul>
        <h3>Gesamt-Monatsrate: €${gesamt_rate.toFixed(2)}</h3>
      `;

      document.getElementById('ergebnis').innerHTML = html;
    }

    function berechneRate(betrag, zinssatz, laufzeit_jahre) {
      if (zinssatz === 0) return betrag / (laufzeit_jahre * 12);
      const r = zinssatz / 12;
      const n = laufzeit_jahre * 12;
      return betrag * r / (1 - Math.pow(1 + r, -n));
    }
  </script>
</body>
</html>
